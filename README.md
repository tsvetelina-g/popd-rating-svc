# POPd Rating Service – Movie Rating Microservice

The POPd Rating Service is a Spring Boot REST API microservice for managing movie ratings. It allows users to submit ratings (1–10 scale), retrieve them, and get rating statistics. This service integrates with the main POPd MVC application.

## Core Features

- **Create & Update Ratings** – Submit or modify ratings for any user and movie
- **Retrieve Ratings** – Get ratings by user and movie ID
- **Delete Ratings** – Remove ratings when needed
- **Movie Statistics** – Average rating and total ratings count per movie
- **User Statistics** – Count of movies rated by a user
- **Latest Ratings** – Fetch a user's most recent ratings (up to 20)

## Tech Stack

- Java 17
- Spring Boot 3.4.0
- MySQL 8 (production), H2 (tests)
- Spring Data JPA / Hibernate
- Maven
- Jakarta Validation
- Lombok

## Prerequisites

- Java 17+
- Maven 3.6+
- MySQL 8 running on localhost:3306
- IntelliJ IDEA recommended for development

## Setup Instructions

### 1. Configure the database

In `src/main/resources/application.properties`:

```properties
spring.datasource.url=jdbc:mysql://localhost:3306/popd_rating_svc?createDatabaseIfNotExist=true
spring.datasource.username=YOUR_USERNAME
spring.datasource.password=YOUR_PASSWORD
```

The database `popd_rating_svc` will be created automatically if it does not exist.

### 2. Run the service

- Open `PopdRatingSvcApplication.java` in IntelliJ
- Run the main method
- Service will start on **http://localhost:8084**

You can also run using Maven:

```bash
mvn spring-boot:run
```

## Testing

- Tests use H2 in-memory database (no setup required)
- Run all tests by right-clicking `src/test/java` → Run All Tests

Test types:

- **Unit tests** – service layer
- **Integration tests** – controller layer
- **End-to-end tests** – `UpsertRatingITest.java`

## Project Structure

```
src/
├── main/java/app/popdratingsvc/
│   ├── model/          # JPA entities
│   ├── repository/     # Repositories
│   ├── service/        # Business logic
│   ├── web/            # REST controllers, DTOs, mappers
│   │   ├── dto/
│   │   └── mapper/
│   ├── exception/      # Custom exceptions
│   └── PopdRatingSvcApplication.java
├── main/resources/
│   └── application.properties
└── test/
    ├── java/           # Test classes
    └── resources/      # H2 test configuration
```

## API Endpoints (prefix `/api/v1`)

### Ratings

- **POST** `/ratings` – Create or update rating
  - Body: `RatingRequest` (userId, movieId, rating)
  - Response: `RatingResponse` (201 Created)

- **GET** `/ratings/{userId}/{movieId}` – Get rating by user/movie
  - Response: `RatingResponse` (200 OK)

- **DELETE** `/ratings/{userId}/{movieId}` – Delete rating
  - Response: 204 No Content

### Statistics

- **GET** `/ratings/{movieId}/stats` – Movie stats (averageRating, allRatingsCount)
- **GET** `/ratings/{userId}/user` – User stats (moviesRatedCount)
- **GET** `/ratings/{userId}/latest-ratings` – Latest ratings by user (max 20)

### Error Handling

- **404 Not Found** – Returned when a rating does not exist
  - Response: `ErrorResponse` with message

## Notes

- Ratings are integers (1–10)
- Each user can submit only one rating per movie (unique constraint)
- `createdOn` and `updatedOn` timestamps are automatically tracked
- Database schema auto-generated by Hibernate
- Service runs on port **8084**
- Fully integrated with the main POPd MVC application
